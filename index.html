<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Galaxy Guardian</title>
    <style>
        /* --- CSS Styling --- */
        body {
            margin: 0;
            font-family: 'Space Mono', monospace; /* A space-y font feel */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #0d0d1a; /* Deep space blue */
            color: #e0e0f0; /* Light, futuristic text */
            overflow: hidden; /* Prevent scrollbars */
            -webkit-user-select: none; /* Disable text selection for better game feel */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation; /* Prevent browser double-tap zoom etc. */
        }

        /* Parallax stars background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20% 30%, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 70% 80%, #eee, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 50% 50%, #eee, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 90% 10%, #eee, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 10% 90%, #eee, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 150px 150px, 200px 200px, 100px 100px, 250px 250px, 120px 120px;
            animation: moveStars 100s linear infinite;
            z-index: -1;
        }

        @keyframes moveStars {
            from { background-position: 0 0; }
            to { background-position: 0 100%; }
        }


        #game-container {
            width: 80vw;
            max-width: 600px; /* Adjusted max-width for phone portrait feel */
            height: 90vh;
            max-height: 800px; /* Adjusted max-height */
            border: 5px solid #4a4a6b; /* Space frame */
            background-color: rgba(13, 13, 26, 0.7); /* Slightly transparent for stars */
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            border-radius: 10px;
        }

        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            text-align: center;
            z-index: 100; /* Ensure screens are on top */
            border-radius: 5px; /* Match container border-radius */
        }

        .hidden {
            display: none !important;
        }

        /* All Buttons */
        button {
            padding: 12px 25px;
            margin: 10px;
            font-size: 1.3em;
            cursor: pointer;
            background-color: #6a0dad; /* Purple accent */
            color: white;
            border: 2px solid #9932cc;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        button:hover {
            background-color: #9932cc;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }

        input[type="text"] {
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #9932cc;
            border-radius: 5px;
            font-size: 1.1em;
            width: 70%;
            max-width: 300px;
            background-color: #333;
            color: #eee;
            text-align: center;
        }

        /* Game Play Screen Layout */
        #game-play-screen {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            padding: 10px;
            box-sizing: border-box;
            background-color: transparent; /* Show parallax background */
        }

        #game-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            padding: 8px 0;
            font-size: 1em;
            background-color: rgba(0,0,0,0.5);
            border-radius: 5px;
            margin-bottom: 8px;
            z-index: 10; /* Above game area */
        }

        #game-area {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: transparent; /* Show parallax background */
            border-radius: 5px;
            cursor: crosshair; /* Indicate firing area */
            touch-action: none; /* Crucial for preventing mobile scrolling */
        }

        /* Spaceship */
        #spaceship {
            position: absolute;
            bottom: 10px;
            width: 70px;
            height: 60px;
            background-color: #00bcd4; /* Cyan blue ship */
            border-radius: 50% 50% 10px 10px;
            left: calc(50% - 35px);
            cursor: grab;
            z-index: 50;
            box-shadow: 0 0 15px #00bcd4; /* Glow effect */
        }

        #spaceship::before { /* Cockpit */
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 25px;
            background-color: #333;
            border-radius: 50%;
            border: 2px solid #555;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        #spaceship.firing .laser-muzzle { /* Laser muzzle flash */
            animation: laserFlash 0.05s linear;
        }

        .laser-muzzle {
            position: absolute;
            bottom: -5px; /* Just below ship */
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 15px;
            background-color: #f00; /* Red laser color */
            border-radius: 2px;
            opacity: 0;
        }

        @keyframes laserFlash {
            0% { opacity: 1; transform: translateX(-50%) scaleY(1); }
            100% { opacity: 0; transform: translateX(-50%) scaleY(0.5); }
        }

        /* Control Button (Pause) */
        #controls {
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 8px 0;
            margin-top: 8px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 5px;
            z-index: 10;
        }
        #controls button {
            padding: 8px 15px;
            font-size: 1.1em;
            margin: 0;
        }


        /* Game Objects (Enemies) */
        .game-object {
            position: absolute;
            border-radius: 50%; /* Default to round for asteroids */
            z-index: 20; /* Above stars, below ship */
            animation: fall linear forwards;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            transform-origin: center center;
        }

        .game-object.popped {
            opacity: 0;
            transform: scale(0.1) rotate(0deg); /* Shrink quickly for explosion */
        }

        /* Specific enemy types */
        .asteroid {
            width: 40px;
            height: 40px;
            background-color: #8B4513; /* Brown */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            animation: fall linear forwards, rotateAsteroid linear infinite;
        }

        .alien-small {
            width: 35px;
            height: 35px;
            background-color: #00ff00; /* Green */
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff00;
        }

        .alien-large {
            width: 50px;
            height: 50px;
            background-color: #800080; /* Purple */
            border-radius: 50%;
            box-shadow: 0 0 15px #800080;
        }


        /* Laser Projectile (from spaceship) */
        .laser-projectile {
            position: absolute;
            width: 6px;
            height: 20px;
            background-color: #ff0000; /* Red laser */
            box-shadow: 0 0 10px #ff0000;
            border-radius: 3px;
            z-index: 30; /* Above enemies */
        }

        /* Explosion Effect */
        .explosion {
            position: absolute;
            width: 60px; /* Size of explosion */
            height: 60px;
            background-color: transparent;
            border-radius: 50%;
            animation: explode 0.3s forwards;
            z-index: 40; /* On top of everything temporarily */
            pointer-events: none; /* Don't block clicks */
        }

        @keyframes explode {
            0% {
                transform: scale(0.1);
                box-shadow: 0 0 0 0 orange, 0 0 0 0 red;
                opacity: 1;
            }
            50% {
                transform: scale(1);
                box-shadow: 0 0 20px 10px yellow, 0 0 40px 15px orange, 0 0 60px 20px red;
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5);
                box-shadow: 0 0 10px 5px yellow, 0 0 20px 10px orange, 0 0 30px 15px red;
                opacity: 0;
            }
        }

        @keyframes fall {
            from { transform: translateY(-100px); }
            to { transform: translateY(calc(100% + 50px)); }
        }

        @keyframes rotateAsteroid {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Boss Specifics */
        #boss {
            position: absolute;
            top: 20px;
            width: 120px;
            height: 120px;
            background-color: #4b0082; /* Indigo */
            border-radius: 15px;
            left: calc(50% - 60px);
            display: none;
            z-index: 30;
            transition: left 0.8s ease-in-out; /* Smooth boss movement */
            box-shadow: 0 0 30px #4b0082, inset 0 0 15px rgba(255,255,255,0.3);
        }

        #boss-health-bar {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            height: 12px;
            background-color: #dc3545; /* Red (empty) */
            border: 1px solid #000;
            box-sizing: border-box;
            border-radius: 3px;
        }

        #boss-health-bar-fill {
            width: 100%;
            height: 100%;
            background-color: #28a745; /* Green (full) */
            transition: width 0.2s ease-out;
            border-radius: 3px;
        }

        .boss-projectile {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #ffc107; /* Orange/Yellow */
            border-radius: 50%;
            z-index: 40; /* Above ship's projectiles */
            box-shadow: 0 0 15px #ffc107;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-screen" class="game-screen">
            <h1>Galaxy Guardian</h1>
            <p>Enter your callsign:</p>
            <input type="text" id="playerNameInput" placeholder="Your Name">
            <button id="startButton">Begin Mission</button>
        </div>

        <div id="game-play-screen" class="game-screen hidden">
            <div id="game-info">
                <p>Pilot: <span id="playerNameDisplay"></span></p>
                <p>Score: <span id="scoreDisplay">0</span></p>
                <p>Lives: <span id="livesDisplay">3</span></p>
                <p>Level: <span id="levelDisplay">1</span></p>
            </div>
            <div id="game-area">
                <div id="spaceship">
                    <div class="laser-muzzle"></div>
                </div>
            </div>
            <div id="controls">
                <button id="pauseButton">Pause</button>
            </div>
        </div>

        <div id="pause-screen" class="game-screen hidden">
            <h1>Mission Paused</h1>
            <button id="continueButton">Resume Mission</button>
            <button id="restartButtonPause">Restart</button>
        </div>

        <div id="level-complete-screen" class="game-screen hidden">
            <h1 id="levelCompleteMessage">Level 1 Cleared!</h1>
            <p>Good work, <span id="levelCompletePlayerName"></span>!</p>
            <button id="nextLevelButton">Advance to Next Sector</button>
        </div>

        <div id="game-over-screen" class="game-screen hidden">
            <h1>MISSION FAILED!</h1>
            <p id="finalScoreMessage">Final Score: <span id="finalScoreDisplay">0</span></p>
            <button id="restartButtonGameOver">Try Again</button>
        </div>
    </div>

    <script>
        /* --- JavaScript Logic --- */
        // --- Game State Variables ---
        let playerName = '';
        let score = 0;
        let lives = 3;
        let level = 1;
        let gameRunning = false;
        let gamePaused = false;
        let gameLoopAnimationFrame; // For requestAnimationFrame
        let enemyGenerationInterval;
        let continuousFireInterval; // For continuous laser fire
        let currentFireRateMS = 200; // Initial fire interval in ms (200ms = 5 shots/sec)
        const MIN_FIRE_RATE_MS = 50; // Fastest fire rate possible (50ms = 20 shots/sec)
        let activeGameObjects = []; // Array to hold active enemies and boss projectiles

        // Boss variables
        let boss = null;
        let bossHealth = 0;
        let bossMaxHealth = 0;
        let bossFiringInterval;
        let bossMovementInterval;
        const BOSS_LEVEL = 3; // The level where the boss appears

        // --- DOM Elements ---
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const pauseScreen = document.getElementById('pause-screen');
        const levelCompleteScreen = document.getElementById('level-complete-screen');
        const gameOverScreen = document.getElementById('game-over-screen');

        const playerNameInput = document.getElementById('playerNameInput');
        const startButton = document.getElementById('startButton');

        const playerNameDisplay = document.getElementById('playerNameDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const livesDisplay = document.getElementById('livesDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const gameArea = document.getElementById('game-area');
        const spaceship = document.getElementById('spaceship');
        const laserMuzzle = document.querySelector('#spaceship .laser-muzzle');
        const pauseButton = document.getElementById('pauseButton');

        const continueButton = document.getElementById('continueButton');
        const restartButtonPause = document.getElementById('restartButtonPause');

        const levelCompleteMessage = document.getElementById('levelCompleteMessage');
        const levelCompletePlayerName = document.getElementById('levelCompletePlayerName');
        const nextLevelButton = document.getElementById('nextLevelButton');

        const finalScoreDisplay = document.getElementById('finalScoreDisplay');
        const restartButtonGameOver = document.getElementById('restartButtonGameOver');

        // --- Game Settings (Adjust for difficulty) ---
        const LEVEL_SETTINGS = {
            1: {
                enemySpeed: 1.5, generationRate: 1500, enemiesToClear: 20,
                enemyTypes: ['asteroid', 'asteroid', 'alien-small'],
                initialFireRate: 200
            },
            2: {
                enemySpeed: 2.0, generationRate: 1200, enemiesToClear: 30,
                enemyTypes: ['asteroid', 'alien-small', 'alien-small', 'alien-large'],
                initialFireRate: 180
            },
            3: { // Boss Level
                enemySpeed: 0, generationRate: 0, enemiesToClear: 1, // Cleared by defeating boss
                bossHealth: 300, bossSpeed: 0.8, bossFireRate: 1200, bossProjectileSpeed: 4,
                initialFireRate: 150
            },
            4: {
                enemySpeed: 2.5, generationRate: 900, enemiesToClear: 40,
                enemyTypes: ['alien-small', 'alien-small', 'alien-large', 'alien-large'],
                initialFireRate: 120
            },
            5: {
                enemySpeed: 3.0, generationRate: 700, enemiesToClear: 50,
                enemyTypes: ['alien-small', 'alien-large', 'alien-large'],
                initialFireRate: 100
            }
        };

        const ENEMY_HITS_REQUIRED = {
            'asteroid': 1,
            'alien-small': 1,
            'alien-large': 3,
            'boss': 1 // Each hit on boss is processed as damage
        };

        const ENEMY_SCORES = {
            'asteroid': 10,
            'alien-small': 20,
            'alien-large': 50
        };

        const ENEMY_SIZES = {
            'asteroid': 40,
            'alien-small': 35,
            'alien-large': 50
        };

        const SPACESHIP_PROJECTILE_SPEED = 15; // Pixels per frame
        const BOSS_PROJECTILE_DAMAGE = 1; // Lives lost if hit by boss projectile
        const MAX_LEVEL = 5;

        let enemiesClearedInLevel = 0;


        // --- Utility Functions ---
        function showScreen(screenElement) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            screenElement.classList.remove('hidden');
        }

        function updateDisplay() {
            playerNameDisplay.textContent = playerName;
            scoreDisplay.textContent = score;
            livesDisplay.textContent = lives;
            levelDisplay.textContent = level;
        }

        function createExplosion(x, y, size = 60) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = `${x - size / 2}px`;
            explosion.style.top = `${y - size / 2}px`;
            explosion.style.width = `${size}px`;
            explosion.style.height = `${size}px`;
            gameArea.appendChild(explosion);
            setTimeout(() => explosion.remove(), 300); // Remove after animation
        }

        // --- Game Logic Functions ---

        function startGame() {
            playerName = playerNameInput.value.trim();
            if (playerName === '') {
                alert('Please enter your callsign!');
                return;
            }
            score = 0;
            lives = 3;
            level = 1;
            enemiesClearedInLevel = 0;
            activeGameObjects.length = 0; // Clear any existing objects
            gameArea.innerHTML = ''; // Clear existing elements
            gameArea.appendChild(spaceship); // Re-add spaceship
            // Reset spaceship position
            spaceship.style.left = `${gameArea.offsetWidth / 2 - spaceship.offsetWidth / 2}px`;

            currentFireRateMS = LEVEL_SETTINGS[1].initialFireRate; // Reset fire rate

            showScreen(gamePlayScreen);
            gameRunning = true;
            gamePaused = false;
            updateDisplay();
            startLevel();
        }

        function startLevel() {
            enemiesClearedInLevel = 0;
            // Clear all active game objects (enemies, projectiles, boss)
            gameArea.querySelectorAll('.game-object, .laser-projectile, .boss-projectile, #boss').forEach(el => el.remove());
            activeGameObjects = []; // Ensure array is empty

            clearInterval(enemyGenerationInterval);
            clearInterval(bossFiringInterval);
            clearInterval(bossMovementInterval);
            if (boss) boss.remove(); // Remove boss if present from previous level
            boss = null; // Clear boss reference

            const currentSettings = LEVEL_SETTINGS[level];
            if (!currentSettings) {
                endGame(true); // Should not happen if all levels covered, acts as a win
                return;
            }

            // Set initial fire rate for the level
            currentFireRateMS = currentSettings.initialFireRate;
            if (isFiringContinuously) { // If player was holding fire, update rate
                stopContinuousFire();
                startContinuousFire();
            }

            if (level === BOSS_LEVEL) {
                spawnBoss();
            } else {
                enemyGenerationInterval = setInterval(generateEnemy, currentSettings.generationRate);
            }

            // Ensure game loop is running
            if (gameLoopAnimationFrame) {
                cancelAnimationFrame(gameLoopAnimationFrame);
            }
            gameLoop();
        }

        function pauseGame() {
            if (!gameRunning) return;
            gamePaused = true;
            showScreen(pauseScreen);
            clearInterval(enemyGenerationInterval);
            clearInterval(continuousFireInterval);
            clearInterval(bossFiringInterval);
            clearInterval(bossMovementInterval);
            cancelAnimationFrame(gameLoopAnimationFrame);
        }

        function continueGame() {
            gamePaused = false;
            showScreen(gamePlayScreen);
            const currentSettings = LEVEL_SETTINGS[level];
            if (level === BOSS_LEVEL) {
                startBossFiring();
                moveBoss();
            } else {
                enemyGenerationInterval = setInterval(generateEnemy, currentSettings.generationRate);
            }
            if (isFiringContinuously) { // Resume continuous fire if it was active
                startContinuousFire();
            }
            gameLoop(); // Resume animation frame loop
        }

        function restartGame() {
            clearInterval(enemyGenerationInterval);
            clearInterval(continuousFireInterval);
            clearInterval(bossFiringInterval);
            clearInterval(bossMovementInterval);
            cancelAnimationFrame(gameLoopAnimationFrame);
            startGame();
        }

        function endGame(win = false) {
            gameRunning = false;
            gamePaused = false;
            clearInterval(enemyGenerationInterval);
            clearInterval(continuousFireInterval);
            clearInterval(bossFiringInterval);
            clearInterval(bossMovementInterval);
            cancelAnimationFrame(gameLoopAnimationFrame);

            // Clean up all remaining game objects
            gameArea.querySelectorAll('.game-object, .laser-projectile, .boss-projectile, #boss').forEach(el => el.remove());
            activeGameObjects = [];
            gameArea.appendChild(spaceship); // Ensure spaceship is back for next game

            if (win) {
                if (level > MAX_LEVEL) { // All levels truly completed
                    levelCompleteMessage.textContent = "Galactic Victory Achieved!";
                    levelCompletePlayerName.textContent = playerName;
                    nextLevelButton.textContent = "Play Again!";
                    nextLevelButton.onclick = restartGame;
                } else { // Current level completed, going to next
                    levelCompleteMessage.textContent = `Sector ${level} Cleared!`;
                    levelCompletePlayerName.textContent = playerName;
                    nextLevelButton.textContent = "Advance to Next Sector";
                    nextLevelButton.onclick = nextLevel;
                }
                showScreen(levelCompleteScreen);

            } else {
                finalScoreDisplay.textContent = score;
                showScreen(gameOverScreen);
            }
        }

        function generateEnemy() {
            if (!gameRunning || gamePaused || level === BOSS_LEVEL) return;

            const currentSettings = LEVEL_SETTINGS[level];
            const enemyType = currentSettings.enemyTypes[Math.floor(Math.random() * currentSettings.enemyTypes.length)];
            const enemySize = ENEMY_SIZES[enemyType];

            const enemy = document.createElement('div');
            enemy.className = `game-object ${enemyType}`;
            enemy.dataset.type = enemyType;
            enemy.dataset.hits = ENEMY_HITS_REQUIRED[enemyType]; // Set initial hits required
            enemy.style.width = `${enemySize}px`;
            enemy.style.height = `${enemySize}px`;
            enemy.style.left = `${Math.random() * (gameArea.offsetWidth - enemySize)}px`;
            enemy.style.top = `-50px`; // Start above the screen
            gameArea.appendChild(enemy);
            activeGameObjects.push(enemy);
        }

        function moveGameObjects() {
            const currentSettings = LEVEL_SETTINGS[level];
            // Iterate backwards when removing elements from an array
            for (let i = activeGameObjects.length - 1; i >= 0; i--) {
                const obj = activeGameObjects[i];

                if (!gameArea.contains(obj) || obj.dataset.popped) { // Check if already removed/popped
                    activeGameObjects.splice(i, 1);
                    continue;
                }

                let currentTop = parseFloat(obj.style.top);

                if (obj.dataset.type && (obj.dataset.type.includes('asteroid') || obj.dataset.type.includes('alien'))) {
                    obj.style.top = `${currentTop + currentSettings.enemySpeed}px`;

                    // Check if enemy went off screen (missed)
                    if (currentTop > gameArea.offsetHeight) {
                        lives--;
                        updateDisplay();
                        createExplosion(obj.offsetLeft + obj.offsetWidth / 2, obj.offsetTop + obj.offsetHeight / 2, obj.offsetWidth); // Explosion at bottom
                        obj.remove();
                        activeGameObjects.splice(i, 1);
                        if (lives <= 0) {
                            endGame();
                            return;
                        }
                    }
                } else if (obj.dataset.type === 'bossProjectile') {
                    obj.style.top = `${currentTop + currentSettings.bossProjectileSpeed}px`;

                    // Check collision with spaceship
                    const spaceshipRect = spaceship.getBoundingClientRect();
                    const projectileRect = obj.getBoundingClientRect();
                    const gameAreaRect = gameArea.getBoundingClientRect();

                    const spaceshipRelRect = {
                        left: spaceshipRect.left - gameAreaRect.left,
                        right: spaceshipRect.right - gameAreaRect.left,
                        top: spaceshipRect.top - gameAreaRect.top,
                        bottom: spaceshipRect.bottom - gameAreaRect.top
                    };
                    const projectileRelRect = {
                        left: projectileRect.left - gameAreaRect.left,
                        right: projectileRect.right - gameAreaRect.left,
                        top: projectileRect.top - gameAreaRect.top,
                        bottom: projectileRect.bottom - gameAreaRect.top
                    };

                    if (
                        projectileRelRect.left < spaceshipRelRect.right &&
                        projectileRelRect.right > spaceshipRelRect.left &&
                        projectileRelRect.top < spaceshipRelRect.bottom &&
                        projectileRelRect.bottom > spaceshipRelRect.top
                    ) {
                        // Collision with spaceship!
                        lives -= BOSS_PROJECTILE_DAMAGE;
                        updateDisplay();
                        createExplosion(obj.offsetLeft + obj.offsetWidth / 2, obj.offsetTop + obj.offsetHeight / 2, 40); // Small explosion
                        obj.remove();
                        activeGameObjects.splice(i, 1);
                        if (lives <= 0) {
                            endGame();
                            return;
                        }
                    }
                    // Remove if off screen
                    else if (currentTop > gameArea.offsetHeight) {
                        obj.remove();
                        activeGameObjects.splice(i, 1);
                    }
                }
            }
        }

        function moveLaserProjectile(projectile) {
            let currentBottom = parseFloat(projectile.style.bottom);
            projectile.style.bottom = `${currentBottom + SPACESHIP_PROJECTILE_SPEED}px`;

            // Check collision with game objects (enemies or boss)
            for (let i = activeGameObjects.length - 1; i >= 0; i--) {
                const obj = activeGameObjects[i];
                // Only consider non-popped enemies or boss
                if ((obj.dataset.popped && obj.dataset.type !== 'boss') || !gameArea.contains(obj)) continue;

                const objRect = obj.getBoundingClientRect();
                const projectileRect = projectile.getBoundingClientRect();
                const gameAreaRect = gameArea.getBoundingClientRect();

                // Adjust rects to be relative to gameArea (important for accurate collision)
                const objRelRect = {
                    left: objRect.left - gameAreaRect.left,
                    right: objRect.right - gameAreaRect.left,
                    top: objRect.top - gameAreaRect.top,
                    bottom: objRect.bottom - gameAreaRect.top
                };
                const projectileRelRect = {
                    left: projectileRect.left - gameAreaRect.left,
                    right: projectileRect.right - gameAreaRect.left,
                    top: projectileRect.top - gameAreaRect.top,
                    bottom: projectileRect.bottom - gameAreaRect.top
                };


                if (
                    projectileRelRect.left < objRelRect.right &&
                    projectileRelRect.right > objRelRect.left &&
                    projectileRelRect.top < objRelRect.bottom &&
                    projectileRelRect.bottom > objRelRect.top
                ) {
                    // Collision!
                    projectile.remove(); // Remove laser projectile

                    if (obj.dataset.type && (obj.dataset.type.includes('asteroid') || obj.dataset.type.includes('alien'))) {
                        obj.dataset.hits--;
                        if (obj.dataset.hits <= 0) {
                            score += ENEMY_SCORES[obj.dataset.type];
                            enemiesClearedInLevel++;
                            createExplosion(obj.offsetLeft + obj.offsetWidth / 2, obj.offsetTop + obj.offsetHeight / 2, obj.offsetWidth);
                            obj.classList.add('popped');
                            obj.dataset.popped = 'true';
                            // Remove from DOM after explosion animation completes
                            setTimeout(() => {
                                if (gameArea.contains(obj)) obj.remove();
                            }, 200);
                        }
                    } else if (obj.id === 'boss') {
                        bossHealth -= 10; // Each laser hit does 10 damage
                        updateBossHealthBar();
                        if (bossHealth <= 0) {
                            score += 500; // Bonus points for boss kill
                            enemiesClearedInLevel++; // Count boss as one cleared object
                            createExplosion(boss.offsetLeft + boss.offsetWidth / 2, boss.offsetTop + boss.offsetHeight / 2, 150); // Large explosion
                            boss.remove();
                            clearInterval(bossFiringInterval);
                            clearInterval(bossMovementInterval);
                            boss = null; // Clear boss reference
                        }
                    }
                    updateDisplay();
                    increaseFireRate(); // Check for fire rate increase
                    checkLevelCompletion();
                    return; // Projectile hit an object, stop checking for this projectile
                }
            }

            // Remove projectile if it goes off screen
            if (currentBottom > gameArea.offsetHeight) {
                projectile.remove();
            }
        }

        function fireSpaceshipProjectile() {
            if (!gameRunning || gamePaused) return;

            spaceship.classList.add('firing'); // Trigger muzzle flash
            laserMuzzle.style.opacity = 1;
            setTimeout(() => {
                spaceship.classList.remove('firing');
                laserMuzzle.style.opacity = 0;
            }, 50); // Muzzle flash duration

            const projectile = document.createElement('div');
            projectile.className = 'laser-projectile';
            // Position projectile from the tip of the spaceship's barrel
            projectile.style.left = `${spaceship.offsetLeft + spaceship.offsetWidth / 2 - 3}px`; // Center horizontally
            projectile.style.bottom = `${spaceship.offsetHeight - 5}px`; // Just above spaceship
            gameArea.appendChild(projectile);
            // Projectiles are not added to activeGameObjects; they are handled by querySelectorAll
        }

        // --- Continuous Fire Logic ---
        function startContinuousFire() {
            if (isFiringContinuously) return; // Prevent multiple intervals
            isFiringContinuously = true;
            fireSpaceshipProjectile(); // Fire immediately on hold
            continuousFireInterval = setInterval(fireSpaceshipProjectile, currentFireRateMS);
        }

        function stopContinuousFire() {
            isFiringContinuously = false;
            clearInterval(continuousFireInterval);
        }

        function increaseFireRate() {
            // Gradually increase fire rate based on score
            // For every 100 points, reduce fire interval by 5ms
            const baseFireRate = LEVEL_SETTINGS[level].initialFireRate;
            const scoreMultiplier = Math.floor(score / 100);
            let newFireRate = baseFireRate - (scoreMultiplier * 5);
            currentFireRateMS = Math.max(newFireRate, MIN_FIRE_RATE_MS);

            // If actively firing, reset interval with new rate
            if (isFiringContinuously) {
                stopContinuousFire();
                startContinuousFire();
            }
        }


        function checkLevelCompletion() {
            const currentSettings = LEVEL_SETTINGS[level];
            if (level === BOSS_LEVEL) {
                if (boss === null) { // Boss is removed from DOM when defeated
                    advanceLevelOrWin();
                }
            } else if (enemiesClearedInLevel >= currentSettings.enemiesToClear) {
                advanceLevelOrWin();
            }
        }

        function advanceLevelOrWin() {
            gameRunning = false;
            clearInterval(enemyGenerationInterval);
            clearInterval(continuousFireInterval);
            clearInterval(bossFiringInterval);
            clearInterval(bossMovementInterval);
            cancelAnimationFrame(gameLoopAnimationFrame);

            if (level < MAX_LEVEL) {
                showScreen(levelCompleteScreen);
            } else {
                endGame(true); // All levels completed, you win!
            }
        }

        function nextLevel() {
            level++;
            if (level > MAX_LEVEL) {
                endGame(true);
                return;
            }
            showScreen(gamePlayScreen);
            gameRunning = true;
            gamePaused = false;
            updateDisplay();
            startLevel();
        }

        // --- Boss Logic ---
        function spawnBoss() {
            boss = document.createElement('div');
            boss.id = 'boss';
            boss.style.display = 'block';

            const healthBar = document.createElement('div');
            healthBar.id = 'boss-health-bar';
            const healthFill = document.createElement('div');
            healthFill.id = 'boss-health-bar-fill';
            healthBar.appendChild(healthFill);
            boss.appendChild(healthBar);

            gameArea.appendChild(boss);
            activeGameObjects.push(boss); // Add boss to active game objects

            const currentSettings = LEVEL_SETTINGS[BOSS_LEVEL];
            bossMaxHealth = currentSettings.bossHealth;
            bossHealth = bossMaxHealth;
            updateBossHealthBar();

            // Initial boss position
            boss.style.left = `${Math.random() * (gameArea.offsetWidth - boss.offsetWidth)}px`;

            startBossFiring();
            moveBoss(); // Start moving the boss
        }

        function updateBossHealthBar() {
            if (boss && document.getElementById('boss-health-bar-fill')) {
                const healthFill = document.getElementById('boss-health-bar-fill');
                const percentage = (bossHealth / bossMaxHealth) * 100;
                healthFill.style.width = `${Math.max(0, percentage)}%`;
                healthFill.style.backgroundColor = percentage > 50 ? '#28a745' : percentage > 20 ? '#ffc107' : '#dc3545'; // Color changes
            }
        }

        function startBossFiring() {
            const currentSettings = LEVEL_SETTINGS[BOSS_LEVEL];
            clearInterval(bossFiringInterval);
            bossFiringInterval = setInterval(fireBossProjectile, currentSettings.bossFireRate);
        }

        function fireBossProjectile() {
            if (!gameRunning || gamePaused || !boss || bossHealth <= 0) return;

            const projectile = document.createElement('div');
            projectile.className = 'boss-projectile';
            projectile.dataset.type = 'bossProjectile';

            // Position projectile from the boss's bottom center
            projectile.style.left = `${boss.offsetLeft + boss.offsetWidth / 2 - 10}px`; // Centered
            projectile.style.top = `${boss.offsetTop + boss.offsetHeight - 5}px`; // Just below boss

            gameArea.appendChild(projectile);
            activeGameObjects.push(projectile);
        }

        function moveBoss() {
            if (!gameRunning || gamePaused || !boss || bossHealth <= 0) return;

            const currentSettings = LEVEL_SETTINGS[BOSS_LEVEL];
            // Boss moves randomly horizontally
            let targetX = Math.random() * (gameArea.offsetWidth - boss.offsetWidth);
            boss.style.left = `${targetX}px`;

            // Adjust movement speed / frequency if needed for difficulty
            bossMovementInterval = setTimeout(moveBoss, 1500 + Math.random() * 1000); // Move every 1.5-2.5 seconds
        }


        // --- Game Loop (requestAnimationFrame for smooth animations) ---
        function gameLoop() {
            if (!gameRunning || gamePaused) return;

            moveGameObjects(); // Move enemies and boss projectiles

            // Move all active spaceship projectiles (lasers)
            gameArea.querySelectorAll('.laser-projectile').forEach(lp => {
                moveLaserProjectile(lp);
            });

            gameLoopAnimationFrame = requestAnimationFrame(gameLoop);
        }

        // --- Event Listeners ---

        // Start Screen
        startButton.addEventListener('click', startGame);
        playerNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') startGame();
        });

        // Game Play Screen - Tap/Hold to Fire & Spaceship Drag
        let isDraggingSpaceship = false;
        let initialSpaceshipX;
        let initialClientX; // Can be mouseX or touchX

        // Mouse/Touch Down on game area
        gameArea.addEventListener('mousedown', (e) => {
            if (!gameRunning || gamePaused) return;

            // If click is on spaceship, initiate drag
            if (e.target === spaceship || spaceship.contains(e.target)) {
                isDraggingSpaceship = true;
                spaceship.style.cursor = 'grabbing';
                initialSpaceshipX = spaceship.offsetLeft;
                initialClientX = e.clientX;
            } else { // Otherwise, fire
                startContinuousFire();
            }
        });

        gameArea.addEventListener('touchstart', (e) => {
            if (!gameRunning || gamePaused || e.touches.length === 0) return;
            e.preventDefault(); // Prevent default browser touch actions (scrolling, zooming)

            // If touch starts on spaceship, initiate drag
            if (e.target === spaceship || spaceship.contains(e.target)) {
                isDraggingSpaceship = true;
                initialSpaceshipX = spaceship.offsetLeft;
                initialClientX = e.touches[0].clientX;
            } else { // Otherwise, fire
                startContinuousFire();
            }
        }, { passive: false });


        // Mouse/Touch Move on the entire gameArea to allow drag
        gameArea.addEventListener('mousemove', (e) => {
            if (isDraggingSpaceship && gameRunning && !gamePaused) {
                const dx = e.clientX - initialClientX;
                let newX = initialSpaceshipX + dx;

                // Constrain spaceship to game area boundaries
                if (newX < 0) newX = 0;
                if (newX > gameArea.offsetWidth - spaceship.offsetWidth) newX = gameArea.offsetWidth - spaceship.offsetWidth;
                spaceship.style.left = `${newX}px`;
            }
        });

        gameArea.addEventListener('touchmove', (e) => {
            if (isDraggingSpaceship && gameRunning && !gamePaused && e.touches.length > 0) {
                e.preventDefault(); // Prevent default browser touch actions (scrolling)
                const dx = e.touches[0].clientX - initialClientX;
                let newX = initialSpaceshipX + dx;

                if (newX < 0) newX = 0;
                if (newX > gameArea.offsetWidth - spaceship.offsetWidth) newX = gameArea.offsetWidth - spaceship.offsetWidth;
                spaceship.style.left = `${newX}px`;
            }
        }, { passive: false });

        // Mouse/Touch Up to stop continuous fire and drag
        document.addEventListener('mouseup', () => {
            isDraggingSpaceship = false;
            spaceship.style.cursor = 'grab';
            stopContinuousFire();
        });

        document.addEventListener('touchend', () => {
            isDraggingSpaceship = false;
            stopContinuousFire();
        });

        // Pause Button
        pauseButton.addEventListener('click', pauseGame);

        // Pause Screen
        continueButton.addEventListener('click', continueGame);
        restartButtonPause.addEventListener('click', restartGame);

        // Level Complete Screen
        nextLevelButton.addEventListener('click', nextLevel);

        // Game Over Screen
        restartButtonGameOver.addEventListener('click', restartGame);

        // Initial setup
        showScreen(startScreen);
        updateDisplay();
    </script>
</body>
</html>
